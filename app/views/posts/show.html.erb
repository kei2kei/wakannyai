<div class="container mx-auto px-4 py-8 max-w-7xl bg-terminal-bg text-terminal-text">
  <div class="bg-terminal-input border border-terminal-border rounded-lg p-8 shadow-sm">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6">
      <h3 class="text-2xl font-bold text-terminal-accent mb-2 md:mb-0">タイトル：<%= @post.title %></h3>
      <span class="text-terminal-text px-2 py-1 rounded text-sm font-semibold 
        <%= @post.unsolved? ? 'bg-red-500/20' : 'bg-green-500/20' %>">
        <%= @post.unsolved? ? '未解決' : '解決済み' %>
      </span>
    </div>

    <div>
      <div class="mt-4 text-terminal-text mb-2">内容：</div>
      <article
        class="prose prose-invert max-w-none
                  border border-terminal-border rounded-lg
                bg-terminal-input p-6 overflow-y-auto shadow-sm
                prose-headings:text-terminal-text
                prose-a:text-terminal-accent
                prose-p: text-terminal-text
                prose-pre:bg-terminal-input
                prose-pre:text-terminal-text
                prose-code:text-terminal-text">
        <%= render_markdown(@post.content) %>
      </article>
    </div>

    <div class="mt-6 border-t border-terminal-border pt-4 text-sm text-gray-400">
      <p>投稿者：<%= @post.user.name %></p>
      <% if @post.tags.any? %>
        <p>タグ：<%= @post.tags.map(&:name).join(', ') %></p>
      <% end %>
    </div>

    <div class="mt-6 flex flex-wrap gap-2 items-center justify-between">
      <div class="flex gap-2">
        <% if current_user && current_user.id == @post.user_id %>
          <%= link_to "編集", edit_post_path(@post), class: "btn-terminal" %>
          <%= link_to "削除", post_path(@post), data: { turbo_method: :delete, confirm: "本当に削除しますか？" }, class: "btn-terminal-danger" %>
          <% if @post.unsolved? %>
            <%= button_to "解決した", solve_post_path(@post), method: :patch, data: { turbo_confirm: 'この問題を解決済みにしますか？' }, class: "btn-terminal-accent" %>
          <% end %>
        <% end%>
      </div>

      <% if current_user && current_user.id == @post.user_id %>
        <% if current_user.github_app_installation_id.blank? %>
          <% install_url = "https://github.com/apps/#{ENV['GITHUB_APP_SLUG']}/installations/new" %>
          <%= link_to "GitHub App をインストール", install_url,
                class: "btn-terminal-accent", data: { turbo: false } %>

        <% elsif current_user.github_repo_full_name.blank? %>
          <%= link_to "同期先を選ぶ", github_repos_path(return_to: post_path(@post)),
                class: "btn-terminal-accent" %>

        <% else %>
          <div class="flex items-center gap-2">
            <%= button_to "GitHubに同期", sync_to_github_post_path(@post),
                  method: :patch, class: "btn-terminal" %>
            <span class="text-xs text-gray-400">
              同期先: <%= current_user.github_repo_full_name %>
              <% if current_user.github_branch.present? %>(<%= current_user.github_branch %>)<% end %>
              · <%= link_to "変更", github_repos_path(return_to: post_path(@post)), class: "underline" %>
            </span>
          </div>
        <% end %>
      <% end %>
    </div>

    <% if @post.github_url.present? && current_user.id == @post.user_id %>
      <div class="mt-3">
        <small class="text-gray-500">
          <%= link_to "GitHubで見る", @post.github_url, target: "_blank", class: "hover:underline text-terminal-accent" %>
          （最終同期: <%= @post.github_synced_at.strftime('%Y/%m/%d %H:%M') %>）
        </small>
      </div>
    <% end %>
  </div>

  <div class="mt-8">
    <h3 class="text-xl font-bold mb-4">コメント</h3>
    <%= render 'comments/form', comment: @comment, parent_comment: @parent_comment, post: @post %>
    <div class="mt-4 space-y-4">
      <% @comments.each do |comment| %>
        <%= render 'comments/comment', comment: comment, post: @post %>
      <% end %>
    </div>
  </div>
</div>