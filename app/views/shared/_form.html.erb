<% unattached_blobs_json = (@unattached_blobs || []).to_json %>

<div class="container mx-auto px-4 py-8 max-w-7xl" data-controller="markdown-editor" data-markdown-editor-unattached-blobs-value="<%= unattached_blobs_json %>">
  <%= form_with model: @post, local: true do |f| %>
    <div class="mb-6">
      <label for="post_title" class="block text-sm font-medium text-terminal-text mb-2" >
        タイトル
      </label>
      <%= f.text_field :title, class: "w-full px-3 py-2 border border-terminal-border bg-terminal-input text-terminal-text rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-terminal-accent/50 focus:border-terminal-accent" %>
    </div>

    <div class="mb-6" data-controller="tag-manager">
      <%= f.label :tag_names, "タグ (カンマ区切り)", class: "block text-sm font-medium text-terminal-text mb-2" %>
      <%= f.text_field :tag_names,
          class: "w-full px-3 py-2 border border-terminal-border bg-terminal-input text-terminal-text rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-terminal-accent/50 focus:border-terminal-accent",
          value: @post.tags.map(&:name).join(', ') %>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 min-h-[500px]">
      <%# エディタ側 %>
      <div class="flex flex-col h-full">
        <label for="markdown-editor" class="block text-sm font-medium text-terminal-text mb-2">
          内容（Markdown形式）
        </label>
        <div class="relative flex-grow">
          <%= f.text_area :content,
              id: "markdown-editor",
              class: "w-full h-full bg-terminal-input border border-terminal-border text-terminal-text rounded-lg",
              data: { "markdown-editor-target": "editor" } %>
        </div>
      </div>

      <%# プレビュー側 %>
      <div class="flex flex-col h-full">
        <label class="block text-sm font-medium text-terminal-text mb-2">
          プレビュー
        </label>
        <div id="preview-container"
            class="prose prose-invert max-w-none
                  border border-terminal-border rounded-lg
                bg-terminal-input p-6 overflow-y-auto shadow-sm
                prose-headings:text-terminal-text
                prose-a:text-terminal-accent
                prose-p: text-terminal-text
                prose-pre:bg-terminal-input
                prose-pre:text-terminal-text
                prose-code:text-terminal-text"
            data-markdown-editor-target="preview">
          <p class="text-gray-400 italic not-prose">ここに内容のプレビューが表示されます</p>
        </div>
      </div>
    </div>

    <% if @unattached_blobs %>
      <% @unattached_blobs.each do |blob| %>
        <input type="hidden" name="post[images][]" value="<%= blob[:signed_id] %>">
      <% end %>
    <% end %>

    <div class="flex justify-end space-x-4 mt-8">
      <button type="button"
              class="px-4 py-2 font-medium bg-terminal-accent text-terminal-bg rounded-lg hover:bg-terminal-accent/80 transition-colors duration-200"
              data-action="click->markdown-editor#insertTemplate">
        テンプレートを挿入
      </button>
      <%= f.submit "保存", class: "px-6 py-2 bg-terminal-accent text-terminal-bg font-medium rounded-lg hover:bg-terminal-accent/80 focus:outline-none focus:ring-2 focus:ring-terminal-accent/50 focus:ring-offset-2 transition-colors duration-200" %>
    </div>
  <% end %>
</div>